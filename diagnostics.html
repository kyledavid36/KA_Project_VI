<!-- ================================================================================
  FILE: diagnostics.html
  AUTHOR: Alan Hpm, Group 4
  PURPOSE:
    - Display a real-time bar chart of CAN bus TX and RX events using Chart.js.
    - Pulls log data from the server via `php/fetchCANlog.php`.
    - Useful for diagnostics and verifying successful communication across nodes.
  USAGE:
    - Load in browser (e.g., http://<Pi-IP>/diagnostics.html)
    - Click "Refresh Logs" to manually reload the chart.
  DEPENDENCIES:
    - Chart.js (CDN)
    - Google Fonts (Cinzel)
    - Backend PHP script: php/fetchCANlog.php (returns JSON of CAN_subnetwork logs)
================================================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CAN Bus Diagnostics</title>

  <!-- Chart.js and Google Fonts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap" rel="stylesheet" />

  <!-- ===== CSS Styling for Chart Container and Buttons ===== -->
  <style>
    body {
      background: url('Images/can_bus.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Cinzel', serif;
      color: #f0e6d2;
      text-align: center;
      padding: 40px 20px;
    }

    h2 {
      font-size: 36px;
      margin-bottom: 30px;
      text-shadow: 2px 2px #000;
    }

    .chart-container {
      width: 95%;
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
    }

    #refresh-button {
      margin-top: 25px;
      padding: 12px 24px;
      background: radial-gradient(circle at 30% 30%, #c4a35a, #7a5c1d);
      color: #fff;
      font-size: 18px;
      border: 4px solid #4b3621;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #refresh-button:hover {
      background: radial-gradient(circle, #d4b05a, #9a6b1c);
      transform: scale(1.05);
    }

    canvas {
      margin-top: 10px;
      max-height: 400px;
    }
  </style>
</head>

<body>
  <!-- ===== PAGE HEADER ===== -->
  <h2>üìä CAN Bus TX & RX Diagnostics</h2>

  <!-- ===== Chart Display Panel ===== -->
  <div class="chart-container">
    <canvas id="canChart"></canvas>
    <button id="refresh-button" onclick="loadChart()">üîÅ Refresh Logs</button>
  </div>

  <!-- ===== JavaScript to Load Chart from fetchCANlog.php ===== -->
  <script>
    let canChart = null;

    function loadChart() {
      fetch("php/fetchCANlog.php")
        .then(response => response.json())
        .then(data => {
          // Extract time labels and event counts
          const labels = data.map(row => row.timestamp);
          const txData = data.map(row => row.direction === "TX" ? 1 : 0);
          const rxData = data.map(row => row.direction === "RX" ? 1 : 0);

          const chartData = {
            labels: labels.reverse(),
            datasets: [
              {
                label: "TX (Sent)",
                data: txData.reverse(),
                backgroundColor: "rgba(54, 162, 235, 0.6)"  // Blue
              },
              {
                label: "RX (Received)",
                data: rxData.reverse(),
                backgroundColor: "rgba(255, 99, 132, 0.6)"  // Red
              }
            ]
          };

          const config = {
            type: "bar",
            data: chartData,
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" },
                title: {
                  display: true,
                  text: "CAN Bus TX vs RX Events (Last 50 Entries)"
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { precision: 0, stepSize: 1 }
                },
                x: {
                  ticks: {
                    autoSkip: true,
                    maxTicksLimit: 20
                  }
                }
              }
            }
          };

          // Replace old chart if exists
          if (canChart) canChart.destroy();
          const ctx = document.getElementById("canChart").getContext("2d");
          canChart = new Chart(ctx, config);
        })
        .catch(err => {
          console.error("‚ùå Error loading CAN log data:", err);
          alert("Failed to load CAN log from server.");
        });
    }

    // Load chart on page load
    window.onload = loadChart;
  </script>
</body>
</html>
